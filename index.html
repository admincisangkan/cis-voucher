<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Klaim Voucher Belanja</title>
  <style>
    /* (Tetap gunakan CSS kamu di sini ‚Äî tidak berubah) */
  </style>
</head>
<body>
  <div class="container" id="mainContent">
    <div class="logo animate">üéâ</div>
    <h1 class="animate">Selamat!</h1>
    <p class="animate delay-1">
      Anda berhak mendapatkan <strong>Voucher Belanja senilai Rp 500.000</strong> dari kami!
      Segera klaim voucher Anda sebelum masa berlaku habis.
    </p>
    <h3 style="text-align: left; margin-bottom: 5px;">Syarat & Ketentuan :</h3>
    <p style="text-align: left; font-size: small;">
      - Voucher hanya berlaku untuk produk Genteng<br/>
      - Voucher hanya berlaku untuk nama<br/>
      - Voucher hanya berlaku untuk 1 orang<br/>
      - Voucher tidak bisa diuangkan<br/>
      - Berlaku selama tahun 2026
    </p>
  </div>

  <div class="overlay active" id="overlay">
    <div class="popup">
      <button class="close-btn" id="closePopup">√ó</button>

      <div class="popup-header">
        <h2 class="popup-title">Klaim Voucher Anda</h2>
        <p class="popup-subtitle">
          Masukkan kode referral untuk memverifikasi klaim voucher belanja Anda
        </p>
      </div>

      <div class="referral-info">
        <div class="info-title">Informasi Referral:</div>
        <div class="info-item"><span class="info-label">Nama:</span> <span id="referralName">-</span></div>
        <div class="info-item"><span class="info-label">Perusahaan:</span> <span id="referralCompany">-</span></div>
      </div>

      <div class="referral-form">
        <div class="form-group">
          <label for="referralInput">Kode Referral Anda</label>
          <input type="text" id="referralInput" placeholder="Masukkan kode referral di sini" />
        </div>
        <button class="submit-btn" id="submitReferral">Verifikasi & Klaim</button>
      </div>
    </div>
  </div>

  <script>
  const urlParams = new URLSearchParams(window.location.search);
  const name = urlParams.get("name") || "Tidak tersedia";
  const company = urlParams.get("company") || "Tidak tersedia";
  const correctReferralCode = urlParams.get("code") || "";

  const overlay = document.getElementById("overlay");
  const closePopupBtn = document.getElementById("closePopup");
  const submitReferralBtn = document.getElementById("submitReferral");
  const referralInput = document.getElementById("referralInput");
  const referralNameElement = document.getElementById("referralName");
  const referralCompanyElement = document.getElementById("referralCompany");
  const mainContent = document.getElementById("mainContent");

  // URL Web App (ganti dengan URL deploy-mu)
  const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyHmeAjIY245YoXZYAMJFnFak9apjlpw6QPW7vWy0TSIGi_D_JTfdF6AL8DgQbryjpq0w/exec";

  let klaimBerhasil = false;

  document.addEventListener("DOMContentLoaded", function () {
    referralNameElement.textContent = name;
    referralCompanyElement.textContent = company;
    overlay.classList.add("active");

    if (localStorage.getItem(correctReferralCode) === "used") {
      referralInput.disabled = true;
      submitReferralBtn.disabled = true;
      submitReferralBtn.style.background = "#888";
      alert("‚ö†Ô∏è Kode referral ini sudah digunakan.");
      mainContent.classList.add("active");
      document.body.style.background = "linear-gradient(135deg, #6a11cb 0%, #2575fc 100%)";
      overlay.classList.remove("active");
    }
  });

  closePopupBtn.addEventListener("click", () => {
    if (klaimBerhasil) overlay.classList.remove("active");
    else alert("Klaim voucher terlebih dahulu sebelum menutup popup.");
  });

  submitReferralBtn.addEventListener("click", async function () {
    const userReferralCode = referralInput.value.trim();
    if (userReferralCode === "") return alert("Silakan masukkan kode referral Anda.");
    if (localStorage.getItem(userReferralCode) === "used")
      return alert("‚ö†Ô∏è Kode referral ini sudah digunakan sebelumnya.");
    if (userReferralCode !== correctReferralCode)
      return alert("‚ùå Kode referral tidak sesuai.");

    // --- Kirim ke Apps Script ---
    try {
      const res = await fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code: userReferralCode }),
      });
      const data = await res.json();
      alert(data.message);

      if (data.success) {
        klaimBerhasil = true;
        localStorage.setItem(userReferralCode, "used");
        document.body.style.background =
          "linear-gradient(135deg, #6a11cb 0%, #2575fc 100%)";
        mainContent.classList.add("active");
        overlay.classList.remove("active");
      }
    } catch (err) {
      alert("‚ùå Gagal mengirim data: " + err);
    }
  });
  </script>
</body>
</html>
